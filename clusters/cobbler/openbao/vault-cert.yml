---
apiVersion: v1
kind: ServiceAccount
metadata:
  creationTimestamp: null
  name: vault-issuer
  namespace: cert-manager
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vault-issuer
  namespace: cert-manager
rules:
  - apiGroups: ['']
    resources: ['serviceaccounts/token']
    resourceNames: ['vault-issuer']
    verbs: ['create']
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vault-issuer
  namespace: cert-manager
subjects:
  - kind: ServiceAccount
    name: cert-manager-cert-manager
    namespace: cert-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: vault-issuer
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: gordns-cobbler
spec:
  vault:
    path: pki/sign/cobbler-gordns-net
    server: https://vault.cobbler.gordns.net:8200
    caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJ3ekNDQVdxZ0F3SUJBZ0lSQU9NY2FUY0tqYWF2dnNHKzZiMXFkZm93Q2dZSUtvWkl6ajBFQXdJd1FERWEKTUJnR0ExVUVDaE1SWW14MVpYTnRiMnRsTG01bGRIZHZjbXN4SWpBZ0JnTlZCQU1UR1dKc2RXVnpiVzlyWlM1dQpaWFIzYjNKcklGSnZiM1FnUTBFd0hoY05NalF3T1RJeE1qQXhORFF6V2hjTk16UXdPVEU1TWpBeE5EUXpXakJBCk1Sb3dHQVlEVlFRS0V4RmliSFZsYzIxdmEyVXVibVYwZDI5eWF6RWlNQ0FHQTFVRUF4TVpZbXgxWlhOdGIydGwKTG01bGRIZHZjbXNnVW05dmRDQkRRVEJaTUJNR0J5cUdTTTQ5QWdFR0NDcUdTTTQ5QXdFSEEwSUFCQS9kMXd5ZwpaSGlCb2VyK1JTQitTQkw3am5DVHRRSzBhcDFDcUh5OGpQcWpQS0NVTldBd3pwNHR3dWFLbm5jMnRVSXp2Qk9nClBlemIzVE51eEhMZ01FcWpSVEJETUE0R0ExVWREd0VCL3dRRUF3SUJCakFTQmdOVkhSTUJBZjhFQ0RBR0FRSC8KQWdFQk1CMEdBMVVkRGdRV0JCUWNjQncyQndmY0JGcklSTjRBdnhaK3NuYU1vakFLQmdncWhrak9QUVFEQWdOSApBREJFQWlBR3V1U2t2RFJDbmxzWGkrRDMrZ1lJNXNjWkFwdGJWTUR4Q3VnRnRoQms0d0lnSEJnaWU3VmJYWVRhCjRJN1g2ODl5dHlpcG5FZmlhN3RtNFRXVk00SmY4RXc9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    auth:
      kubernetes:
        role: vault-issuer-role
        mountPath: /v1/auth/kubernetes
        serviceAccountRef:
          name: vault-issuer
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: vault.cobbler.gordns.net
  namespace: openbao
spec:
  # Secret names are always required.
  secretName: vault-tls-cert
  commonName: vault.cobbler.gordns.net

  duration: 2160h # 90d
  renewBefore: 360h # 15d

  # At least one of commonName (possibly through literalSubject), dnsNames, uris, emailAddresses, ipAddresses or otherNames is required.
  dnsNames:
    - vault.cobbler.gordns.net
  ipAddresses:
    - 127.0.0.1

  # Issuer references are always required.
  issuerRef:
    name: gordns-cobbler
    # We can reference ClusterIssuers by changing the kind here.
    # The default value is Issuer (i.e. a locally namespaced Issuer)
    kind: ClusterIssuer
